<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U+Bank Travel Portal</title>
    <meta name="description" content="U+Bank Travel Portal - Your gateway to exclusive travel benefits, foreign transaction fee waivers, and dedicated travel support." />
    <!-- Pega Chat Widget Script -->
    <script src="https://widget.use1.chat.pega.digital/e03b7c71-ac8b-4cb4-b890-d813ff3b9074/widget.js"></script>
    <style>
      .splash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f5f5f5;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: Arial, sans-serif;
      }
      .splash img {
        width: 150px;
        margin-bottom: 20px;
      }

      /* Styles for the clock and trigger indicator */
      #triggerClock {
        position: fixed;
        left: 20px;
        bottom: 20px;
        background-color: #3C8712;
        color: white;
        padding: 12px 15px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        z-index: 999998;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border: 2px solid white;
      }

      #triggerClock:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      }

      #triggerStatus {
        position: fixed;
        left: 20px;
        bottom: 80px;
        background-color: rgba(0,0,0,0.85);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 999997;
        min-width: 250px;
        display: none;
        font-family: Arial, sans-serif;
        border: 2px solid #3C8712;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      }

      .status-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #3C8712;
      }

      .status-countdown {
        font-size: 28px;
        margin: 10px 0;
        text-align: center;
      }

      .status-message {
        margin-top: 8px;
      }

      .pulse {
        animation: pulse-animation 1.5s infinite;
      }

      @keyframes pulse-animation {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); background-color: #ff6b00; }
        100% { transform: scale(1); }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="splash">
        <img src="./img/u+-logo.svg" alt="U+ Bank">
        <div>
          <strong>We're sorry but U+Bank Travel Portal doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
        </div>
      </div>
    </div>

    <!-- Clock and Trigger Status Elements -->
    <div id="triggerClock">‚è∞</div>
    <div id="triggerStatus">
      <div class="status-title">Proactive Chat Trigger</div>
      <div class="status-countdown" id="statusCountdown">10</div>
      <div class="status-message" id="statusMessage">Waiting to start countdown...</div>
    </div>

    <script type="module" src="/src/main.js"></script>

    <!-- UPDATED: Proactive chat trigger that fires after 10 seconds -->
    <script>
      // Add clock click behavior
      document.getElementById('triggerClock').addEventListener('click', function() {
        var statusEl = document.getElementById('triggerStatus');
        if (statusEl.style.display === 'none' || !statusEl.style.display) {
          statusEl.style.display = 'block';
          this.classList.add('pulse');
        } else {
          statusEl.style.display = 'none';
          this.classList.remove('pulse');
        }
      });

      // Immediately register this function to run after the page is loaded
      console.log("üöÄ TimeOnTravelPage trigger script loaded - UPDATED VERSION");

      // Track global trigger state
      window.triggerState = {
        started: false,
        countdown: 10,
        status: 'Ready to start'
      };

      // Update the visible status
      function updateTriggerStatus(countdown, message) {
        // Update global state
        window.triggerState.countdown = countdown;
        window.triggerState.status = message;

        // Update UI elements
        var countdownEl = document.getElementById('statusCountdown');
        var messageEl = document.getElementById('statusMessage');

        if (countdownEl) countdownEl.textContent = countdown;
        if (messageEl) messageEl.textContent = message;

        // Auto-show the status when important events happen
        if (message.includes('FIRING') || message.includes('ERROR') || message.includes('triggered')) {
          document.getElementById('triggerStatus').style.display = 'block';
          document.getElementById('triggerClock').classList.add('pulse');
        }
      }

      // Display an on-screen timer for demonstration
      function showCountdownNotification(seconds, message) {
        console.log(`Creating notification: ${message || 'Countdown: ' + seconds}`);

        // Update the trigger status
        updateTriggerStatus(seconds, message || `Countdown in progress: ${seconds}s remaining`);

        // Create or get the notification div
        var notificationDiv = document.getElementById('proactiveChatTimer') || document.createElement('div');
        notificationDiv.id = 'proactiveChatTimer';
        notificationDiv.style.position = 'fixed';
        notificationDiv.style.bottom = '20px';
        notificationDiv.style.right = '20px';
        notificationDiv.style.padding = '15px';
        notificationDiv.style.background = 'rgba(0,0,0,0.8)';
        notificationDiv.style.color = 'white';
        notificationDiv.style.borderRadius = '8px';
        notificationDiv.style.zIndex = '999999';
        notificationDiv.style.fontSize = '16px';
        notificationDiv.style.fontFamily = 'Arial, sans-serif';
        notificationDiv.style.border = '2px solid #3C8712';
        notificationDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        notificationDiv.textContent = message || `Proactive chat trigger in ${seconds} seconds`;

        if (!document.getElementById('proactiveChatTimer')) {
          console.log('Appending timer notification to body');
          document.body.appendChild(notificationDiv);
        }

        return notificationDiv;
      }

      // Main function to handle the proactive chat trigger
      function startProactiveTrigger() {
        // Mark as started in global state
        window.triggerState.started = true;

        console.log('‚è±Ô∏è Starting TimeOnTravelPage proactive trigger countdown');
        updateTriggerStatus(10, "Starting 10 second countdown");

        // Show initial notification immediately
        showCountdownNotification(10, "TimeOnTravelPage trigger in 10 seconds");

        // Track start time
        let startTime = Date.now();
        let timeElapsed = 0;
        let timerNotification;

        // Create a countdown timer that updates every second
        const timerInterval = setInterval(function() {
          timeElapsed = Math.floor((Date.now() - startTime) / 1000);
          const remainingSeconds = 10 - timeElapsed;

          if (remainingSeconds >= 0) {
            console.log(`‚è±Ô∏è TimeOnTravelPage trigger countdown: ${remainingSeconds} seconds remaining`);
            timerNotification = showCountdownNotification(remainingSeconds);
          }

          // When countdown reaches zero, trigger the chat
          if (timeElapsed >= 10) {
            clearInterval(timerInterval);
            console.log('üîî EXECUTING proactive chat trigger: TimeOnTravelPage');
            updateTriggerStatus(0, "EXECUTING trigger NOW");

            // Make the clock pulse
            document.getElementById('triggerClock').classList.add('pulse');

            // Check if widget exists and trigger the chat
            if (window.PegaUnifiedChatWidget && typeof window.PegaUnifiedChatWidget.triggerChat === 'function') {
              try {
                // Add a visible notification
                const triggerNotification = showCountdownNotification(0, "‚ö° FIRING TimeOnTravelPage trigger NOW ‚ö°");

                // Actually trigger the chat
                window.PegaUnifiedChatWidget.triggerChat("TimeOnTravelPage");
                console.log('‚úÖ Successfully triggered TimeOnTravelPage chat');

                // Update the trigger status
                updateTriggerStatus(0, "‚úÖ Trigger successfully executed!");

                // Update the notification
                setTimeout(function() {
                  triggerNotification.textContent = "‚úÖ TimeOnTravelPage trigger executed!";

                  // Remove notification after a few seconds
                  setTimeout(function() {
                    if (triggerNotification && triggerNotification.parentNode) {
                      triggerNotification.parentNode.removeChild(triggerNotification);
                    }
                  }, 5000);
                }, 1000);
              } catch(e) {
                console.error("‚ùå Error triggering chat:", e);
                showCountdownNotification(0, "‚ùå Error: " + e.message);
                updateTriggerStatus(0, "‚ùå ERROR: " + e.message);
              }
            } else {
              console.error("‚ùå PegaUnifiedChatWidget not available or triggerChat is not a function");
              console.log("Widget status:", window.PegaUnifiedChatWidget ? "Exists" : "Missing");
              if (window.PegaUnifiedChatWidget) {
                console.log("Available methods:", Object.keys(window.PegaUnifiedChatWidget));
              }
              showCountdownNotification(0, "‚ùå Error: Widget not ready");
              updateTriggerStatus(0, "‚ùå ERROR: Widget not available");
            }
          }
        }, 1000);
      }

      // Function to check if Pega widget is loaded
      function checkPegaWidgetAndStart() {
        console.log("Checking if Pega widget is loaded...");
        updateTriggerStatus(10, "Checking if widget is loaded...");

        if (window.PegaUnifiedChatWidget) {
          console.log("‚úÖ PegaUnifiedChatWidget found, starting countdown");
          updateTriggerStatus(10, "Widget found, starting countdown");
          startProactiveTrigger();
        } else {
          console.log("‚è≥ PegaUnifiedChatWidget not found yet, waiting...");
          updateTriggerStatus(10, "Waiting for widget to load...");
          // Check again in 1 second
          setTimeout(checkPegaWidgetAndStart, 1000);
        }
      }

      // Start checking once DOM is loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          console.log("DOM loaded, waiting 1 second for widget initialization");
          updateTriggerStatus(10, "DOM loaded, initializing...");
          setTimeout(checkPegaWidgetAndStart, 1000);
        });
      } else {
        console.log("DOM already loaded, waiting 1 second for widget initialization");
        updateTriggerStatus(10, "DOM loaded, initializing...");
        setTimeout(checkPegaWidgetAndStart, 1000);
      }

      // Also listen for the widget loaded event
      document.addEventListener("PegaChatWidget:Loaded", function() {
        console.log("üì± PegaChatWidget:Loaded event received");
        // Let's directly start the trigger if this event fires and we haven't started yet
        if (!window.proactiveTriggerStarted) {
          window.proactiveTriggerStarted = true;
          console.log("Starting trigger from loaded event");
          updateTriggerStatus(10, "Widget loaded event received, starting countdown");
          startProactiveTrigger();
        }
      });

      // Global function to manually trigger (can be called from console for testing)
      window.triggerTimeOnTravelPage = function() {
        console.log("üîî Manually triggering TimeOnTravelPage");
        updateTriggerStatus(0, "Manually triggering NOW");
        if (window.PegaUnifiedChatWidget && typeof window.PegaUnifiedChatWidget.triggerChat === 'function') {
          window.PegaUnifiedChatWidget.triggerChat("TimeOnTravelPage");
          updateTriggerStatus(0, "‚úÖ Manual trigger executed!");
          return "Trigger sent!";
        } else {
          console.error("Widget not available");
          updateTriggerStatus(0, "‚ùå ERROR: Widget not available");
          return "Widget not available";
        }
      };
    </script>
  </body>
</html>
